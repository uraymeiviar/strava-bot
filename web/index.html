<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strava Club Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">February Challenge üèÉ‚Äç‚ôÇÔ∏è</h1>
            <p class="text-gray-600">Sync your runs and climb the leaderboard!</p>
        </header>

        <div id="success-alert" class="hidden max-w-lg mx-auto mb-8 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 shadow-md" role="alert">
            <p class="font-bold">Registration Successful!</p>
            <p>You are now connected. Your activities will be synced nightly.</p>
        </div>

        <div class="flex flex-col md:flex-row gap-8">
            <div class="md:w-1/3 bg-white p-6 rounded-lg shadow-md h-fit">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Join the Club</h2>
                <p class="text-gray-500 mb-6 text-sm">One-time authorization required to track your points automatically.</p>
                
                <a href="https://www.strava.com/oauth/authorize?client_id=YOUR_STRAVA_ID&response_type=code&redirect_uri=https://YOUR_CLOUD_FUNCTION_URL&scope=read,activity:read_all" 
                   class="block w-full text-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded transition duration-200">
                    Connect with Strava
                </a>
            </div>

            <div class="md:w-2/3 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-6 text-gray-700">Leaderboard</h2>
                <div id="leaderboard-container">
                    <p class="text-gray-400 italic">Fetching the latest stats...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Check for success status in URL after redirect
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('status') === 'success') {
            document.getElementById('success-alert').classList.remove('hidden');
        }

        // 2. Fetch and render the scoreboard.json
        async function fetchLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            try {
                // This fetches the JSON file generated by your GitHub Action
                const response = await fetch('./scoreboard.json');
                if (!response.ok) throw new Error('No data found');
                
                const data = await response.json();

                if (data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No activities recorded yet for this month.</p>';
                    return;
                }

                let html = `
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b text-gray-600 uppercase text-xs">
                                <th class="py-3 px-2">Rank</th>
                                <th class="py-3 px-2">Athlete</th>
                                <th class="py-3 px-2">Distance</th>
                                <th class="py-3 px-2 font-bold">Points</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach((athlete, index) => {
                    html += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-4 px-2 text-gray-500">#${index + 1}</td>
                            <td class="py-4 px-2 font-medium">${athlete.name}</td>
                            <td class="py-4 px-2 text-gray-500">${athlete.distance} km</td>
                            <td class="py-4 px-2 font-bold text-orange-600">${athlete.points}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (err) {
                console.log(err);
                container.innerHTML = '<p class="text-gray-400 italic text-sm">The first sync will run tonight at 2 AM. Check back soon!</p>';
            }
        }

        fetchLeaderboard();
    </script>
</body>
</html>